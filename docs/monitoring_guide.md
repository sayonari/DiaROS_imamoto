# DiaROS監視ツールガイド

## 概要

DiaROSには、音声対話システムの動作を監視・デバッグするための統合モニタリングツール`monitor.sh`が用意されています。このツールはDocker環境でDiaROSを実行している際に、システムの状態をリアルタイムで監視し、問題の診断を支援します。

## monitor.shの起動方法

```bash
# DiaROSプロジェクトのルートディレクトリから実行
./scripts/monitor.sh
```

**前提条件**：
- DiaROSコンテナ（`diaros_container`）が起動していること
- macOSの場合：XQuartzがインストール・起動されていること

## メニュー構成

monitor.shを起動すると、以下の3つのカテゴリに分類されたメニューが表示されます：

### 1. 基本ROS2ツール（1-8）

標準的なROS2の監視・デバッグツールです：

| 番号 | ツール名 | 説明 |
|------|----------|------|
| 1 | rqt | 統合GUIダッシュボード。複数のツールを同時に表示 |
| 2 | rqt_graph | ノード間の通信をグラフィカルに表示 |
| 3 | rqt_plot | トピックのデータをリアルタイムグラフで表示 |
| 4 | rqt_topic | トピックの一覧と詳細情報を表示 |
| 5 | rqt_bag | 録画したbagファイルの内容を確認 |
| 6 | rqt_console | ログメッセージをフィルタリング・表示 |
| 7 | ros2 topic list | コマンドラインでトピック一覧を表示 |
| 8 | ros2 bag record | 通信データの録画を開始 |

### 2. DiaROS専用モニタリング（9-17）

DiaROSの音声対話システムに特化した監視機能です：

| 番号 | 機能名 | 説明 |
|------|--------|------|
| 9 | システムヘルスチェック | 稼働中のDiaROSノードとトピック周期を確認 |
| 10 | 対話フロー監視 | 音声入力→認識→対話管理→音声合成の流れを監視 |
| 11 | 音声入力モニター | マイク入力の周波数を監視 |
| 12 | 音声認識モニター | ASR（自動音声認識）の出力を表示 |
| 13 | 対話状態総合モニター | 4分割画面で主要トピックを同時監視 |
| 14 | ターンテイキングモニター | 話者交代の検出状況を監視 |
| 15 | バックチャネルモニター | 相槌（「はい」「うん」等）の生成を監視 |
| 16 | 対話セッション録画 | すべてのDiaROSトピックを録画 |
| 17 | 対話フローグラフ表示 | DiaROSトピックのみをフィルタリングしたグラフ表示 |

### 3. 性能監視・デバッグツール（18-23）

システムのパフォーマンスを詳細に分析するツールです：

| 番号 | 機能名 | 説明 |
|------|--------|------|
| 18 | トピック周期監視 | 指定したトピックの更新周期を測定 |
| 19 | 複数トピック同時周期監視 | 主要トピックの周期を一度に測定 |
| 20 | エンドツーエンド遅延測定 | 音声入力から出力までの総遅延を測定 |
| 21 | Plotjuggler起動 | 高度なリアルタイムデータ可視化ツール |
| 22 | 性能トレース記録 | 詳細な実行トレースを記録（要ros2-tracing） |
| 23 | システムリソース監視 | CPU/メモリ使用状況を表示 |

## 使用例

### 例1：対話システムの動作確認

新規にDiaROSを起動した後の基本的な動作確認：

1. **システムヘルスチェック（9番）**を実行
   - すべてのノードが起動していることを確認
   - トピック周期が正常であることを確認

2. **対話フロー監視（10番）**を実行
   - 音声入力が正しく受信されているか確認
   - 音声認識結果が表示されるか確認
   - システムの応答が生成されているか確認

### 例2：音声認識の問題診断

音声認識がうまく動作しない場合：

1. **音声入力モニター（11番）**で音声入力を確認
   - 周波数が表示されない場合：マイクデバイスの問題
   - 周波数が低すぎる場合：音声が小さすぎる可能性

2. **音声認識モニター（12番）**でASR出力を確認
   - 認識結果が表示されない場合：ASRモジュールの問題
   - 誤認識が多い場合：ノイズや発話の問題

3. **対話状態総合モニター（13番）**で全体の流れを確認
   - tmuxで4分割表示され、問題箇所を特定しやすい

### 例3：性能問題の診断

システムの応答が遅い場合：

1. **複数トピック同時周期監視（19番）**を実行
   - 各モジュールの処理周期を確認
   - 特定のモジュールでボトルネックを特定

2. **システムリソース監視（23番）**を実行
   - CPU使用率が高い場合：処理負荷の問題
   - メモリ使用量が多い場合：メモリリークの可能性

3. **対話セッション録画（16番）**で問題を記録
   - 後で詳細な分析が可能
   - 問題の再現性を確認

### 例4：デバッグ用のデータ収集

問題の報告や分析のためのデータ収集：

1. **ros2 bag record（8番）**で全トピックを録画
   - "all"を入力してすべてのトピックを記録
   - 問題が発生したらCtrl+Cで停止

2. **rqt_bag（5番）**で録画内容を確認
   - 記録されたデータの整合性を確認
   - 特定の時点のデータを詳細に調査

## トラブルシューティング

### XQuartzエラー（macOSのみ）

GUIツールが起動しない場合：

1. XQuartzがインストールされているか確認
2. XQuartzを起動
3. XQuartzの設定で「ネットワーククライアントからの接続を許可」を有効化
4. ターミナルで以下を実行：
   ```bash
   /opt/X11/bin/xhost +localhost
   ```

### tmuxエラー

対話状態総合モニター（13番）でエラーが出る場合：

1. Dockerコンテナ内にtmuxがインストールされているか確認
2. 必要に応じてコンテナ内でインストール：
   ```bash
   docker exec -it diaros_container apt update && apt install tmux
   ```

### Plotjugglerが見つからない

21番でPlotjugglerが起動しない場合：

1. Dockerコンテナ内でインストール：
   ```bash
   docker exec -it diaros_container apt install ros-humble-plotjuggler-ros
   ```

## 高度な使い方

### カスタムトピックの監視

特定のトピックを詳細に監視したい場合：

```bash
# monitor.shの外で直接実行
docker exec -it diaros_container bash -c "source /opt/ros/humble/setup.bash && source /DiaROS_ros/install/local_setup.bash && ros2 topic echo /your_custom_topic"
```

### 複数の監視ツールの同時使用

複数のターミナルウィンドウで異なる監視ツールを同時に実行することで、より包括的な監視が可能です：

- ターミナル1：対話フロー監視（10番）
- ターミナル2：システムリソース監視（23番）
- ターミナル3：ros2 bag record（8番）

### 監視データのエクスポート

録画したbagファイルは`/recordings`ディレクトリに保存されます。これらのファイルは後で分析したり、問題の再現に使用できます：

```bash
# ホストマシンにコピー
docker cp diaros_container:/recordings/diaros_dialog_20240630_120000 ./
```

## 性能指標の目安

正常に動作しているDiaROSシステムの典型的な性能指標：

| 指標 | 正常値 | 注意値 | 異常値 |
|------|--------|--------|--------|
| 音声入力周期 | 40-50 Hz | 20-40 Hz | < 20 Hz |
| ASR処理時間 | < 100ms | 100-500ms | > 500ms |
| 対話管理応答 | < 50ms | 50-200ms | > 200ms |
| 音声合成時間 | < 200ms | 200-1000ms | > 1000ms |
| エンドツーエンド遅延 | < 1秒 | 1-2秒 | > 2秒 |

これらの値は、ハードウェアやモデルの設定により変動します。

## まとめ

monitor.shは、DiaROSの開発・デバッグ・運用において不可欠なツールです。定期的にシステムの健全性をチェックし、問題が発生した場合は適切な監視ツールを使用して原因を特定してください。

より詳細な情報や具体的な問題解決方法については、DiaROSのGitHubリポジトリのIssuesセクションを参照するか、開発者にお問い合わせください。